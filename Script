--// Optimized Inventory-style Menu Button + Tabbed GUI
--// Drop into a LocalScript (StarterPlayerScripts recommended)

if game.PlaceId ~= 118561469792373 then return end

-- Defaults
_G.start = (_G.start == nil) and true or _G.start
_G.spamwave = (_G.spamwave == nil) and false or _G.spamwave
_G.autobuyMrsclaus = (_G.autobuyMrsclaus == nil) and false or _G.autobuyMrsclaus
_G.autobuyClasher = (_G.autobuyClasher == nil) and false or _G.autobuyClasher
_G.autobuyGrinch = (_G.autobuyGrinch == nil) and false or _G.autobuyGrinch

_G.__AutoController = _G.__AutoController or {}
local C = _G.__AutoController
if C.__UI_LOADED then return end
C.__UI_LOADED = true

-- Services / Remotes
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RS = game:GetService("ReplicatedStorage")
local Events = RS:WaitForChild("Events")
local player = Players.LocalPlayer

local SurrenderEvent = Events:WaitForChild("Surrender")
local StartWaveEvent = Events:WaitForChild("StartWave")
local BuyTroopEvent = Events:WaitForChild("BuyTroop")
local islandsFolder = workspace:WaitForChild("WorkArea"):WaitForChild("Islands")

-- ===== OPTIMIZATION: Value change notification system =====
local changeSignals = {}
local function createSignal()
	local connections = {}
	return {
		Connect = function(_, callback)
			table.insert(connections, callback)
			return {
				Disconnect = function()
					local idx = table.find(connections, callback)
					if idx then table.remove(connections, idx) end
				end
			}
		end,
		Fire = function()
			for _, callback in ipairs(connections) do
				task.spawn(callback)
			end
		end
	}
end

for _, flag in ipairs({"start", "spamwave", "autobuyMrsclaus", "autobuyClasher", "autobuyGrinch"}) do
	changeSignals[flag] = createSignal()
end

-- Override _G setters to trigger signals
local flagWatchers = {}
for flag, signal in pairs(changeSignals) do
	flagWatchers[flag] = _G[flag]
end

task.spawn(function()
	while true do
		for flag, signal in pairs(changeSignals) do
			if _G[flag] ~= flagWatchers[flag] then
				flagWatchers[flag] = _G[flag]
				signal:Fire()
			end
		end
		task.wait(0.2) -- Only check for external changes, not every UI refresh
	end
end)

-- ===== OPTIMIZED: Helpers =====
local function waitUntilOn(flagName)
	while not _G[flagName] do task.wait(0.2) end
end

-- OPTIMIZED: More efficient wait loop
local function waitWhileOn(seconds, flagName)
	local endTime = os.clock() + seconds
	while os.clock() < endTime and _G[flagName] do
		task.wait(1)
	end
end

local function teleportToSanta()
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	local santa = workspace:WaitForChild("LeaderboardIsland"):WaitForChild("Santa")
	local targetPart = santa:IsA("BasePart") and santa or santa:FindFirstChildWhichIsA("BasePart", true)
	if not targetPart then return end
	hrp.CFrame = targetPart.CFrame * CFrame.new(0, 0, -6)
end

local function teleportToMyIsland()
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	local islandName = tostring(player:WaitForChild("Island").Value)
	local islandModel = islandsFolder:WaitForChild(islandName)
	local spawn = islandModel:FindFirstChild("SpawnLocation", true)
	if not spawn then return warn("No SpawnLocation in", islandName) end
	hrp.CFrame = spawn.CFrame + Vector3.new(0, 3, 0)
end

-- ===== OPTIMIZED: Workers (removed redundant checks) =====
if not C.startThread then
	C.startThread = task.spawn(function()
		while true do
			waitUntilOn("start")
			while _G.start do
				StartWaveEvent:FireServer()
				task.wait()
				SurrenderEvent:FireServer()
				task.wait()
			end
		end
	end)
end

if not C.spamwaveThread then
	C.spamwaveThread = task.spawn(function()
		while true do
			waitUntilOn("spamwave")
			while _G.spamwave do
				for i = 1, 100 do
					StartWaveEvent:FireServer()
					task.wait()
					SurrenderEvent:FireServer()
					task.wait()
				end
				if not _G.spamwave then break end
				for i = 1, 10 do
					StartWaveEvent:FireServer()
					task.wait()
				end
				if not _G.spamwave then break end
				waitWhileOn(180, "spamwave")
				if _G.spamwave then
					SurrenderEvent:FireServer()
				end
			end
		end
	end)
end

-- OPTIMIZED: Generic auto-buy function to reduce code duplication
local function createAutoBuyThread(flagName, troopName)
	return task.spawn(function()
		while true do
			waitUntilOn(flagName)
			while _G[flagName] do
				BuyTroopEvent:FireServer(troopName)
				task.wait(15)
			end
		end
	end)
end

if not C.buymrsclausThread then
	C.buymrsclausThread = createAutoBuyThread("autobuyMrsclaus", "MrsClausTroop")
end
if not C.buyclasherThread then
	C.buyclasherThread = createAutoBuyThread("autobuyClasher", "ClasherTroop")
end
if not C.buygrinchThread then
	C.buygrinchThread = createAutoBuyThread("autobuyGrinch", "GrinchTroop")
end

-- ===== GUI =====
local gui = Instance.new("ScreenGui")
gui.Name = "AutoSwitchUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

-- Menu icon
local menuSlot = Instance.new("Frame")
menuSlot.Parent = gui
menuSlot.Size = UDim2.new(0, 64, 0, 64)
menuSlot.Position = UDim2.new(1, -24, 1, -18)
menuSlot.AnchorPoint = Vector2.new(1, 1)
menuSlot.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
menuSlot.BorderSizePixel = 0

Instance.new("UICorner", menuSlot).CornerRadius = UDim.new(0, 16)

local slotStroke = Instance.new("UIStroke", menuSlot)
slotStroke.Thickness = 2
slotStroke.Color = Color3.fromRGB(70, 70, 70)
slotStroke.Transparency = 0.15

local glow = Instance.new("ImageLabel", menuSlot)
glow.BackgroundTransparency = 1
glow.Size = UDim2.new(1, 26, 1, 26)
glow.Position = UDim2.new(0.5, 0, 0.5, 0)
glow.AnchorPoint = Vector2.new(0.5, 0.5)
glow.Image = "rbxassetid://4996891970"
glow.ImageTransparency = 0.55
glow.ImageColor3 = Color3.fromRGB(90, 180, 255)

local menuBtn = Instance.new("TextButton", menuSlot)
menuBtn.Size = UDim2.new(1, 0, 1, 0)
menuBtn.BackgroundTransparency = 1
menuBtn.Text = "ðŸ‘¾"
menuBtn.Font = Enum.Font.GothamBlack
menuBtn.TextSize = 28
menuBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
menuBtn.AutoButtonColor = false

-- Main Window
local window = Instance.new("Frame", gui)
window.Size = UDim2.new(0, 340, 0, 240)
window.AnchorPoint = Vector2.new(0.5, 0.5)
window.Position = UDim2.new(0.5, 0, 0.52, 0)
window.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
window.BorderSizePixel = 0
window.Active = true
window.Draggable = true
window.Visible = false

Instance.new("UICorner", window).CornerRadius = UDim.new(0, 16)

local winStroke = Instance.new("UIStroke", window)
winStroke.Thickness = 2
winStroke.Color = Color3.fromRGB(70, 70, 70)
winStroke.Transparency = 0.2

local winShadow = Instance.new("ImageLabel", window)
winShadow.BackgroundTransparency = 1
winShadow.ZIndex = 0
winShadow.Size = UDim2.new(1, 70, 1, 70)
winShadow.Position = UDim2.new(0.5, 0, 0.5, 0)
winShadow.AnchorPoint = Vector2.new(0.5, 0.5)
winShadow.Image = "rbxassetid://4996891970"
winShadow.ImageTransparency = 0.80
winShadow.ImageColor3 = Color3.fromRGB(0, 0, 0)

-- Header
local header = Instance.new("Frame", window)
header.Size = UDim2.new(1, 0, 0, 46)
header.BackgroundColor3 = Color3.fromRGB(14, 14, 14)
header.BorderSizePixel = 0
Instance.new("UICorner", header).CornerRadius = UDim.new(0, 16)

local title = Instance.new("TextLabel", header)
title.BackgroundTransparency = 1
title.Position = UDim2.new(0, 14, 0, 0)
title.Size = UDim2.new(1, -90, 1, 0)
title.Font = Enum.Font.GothamBold
title.Text = "Auto Controls"
title.TextSize = 16
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextXAlignment = Enum.TextXAlignment.Left

local closeBtn = Instance.new("TextButton", header)
closeBtn.Size = UDim2.new(0, 28, 0, 28)
closeBtn.Position = UDim2.new(1, -38, 0.5, -14)
closeBtn.BackgroundTransparency = 1
closeBtn.BorderSizePixel = 0
closeBtn.AutoButtonColor = false
closeBtn.Text = "âŒ"
closeBtn.Font = Enum.Font.GothamBlack
closeBtn.TextSize = 20
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)

-- OPTIMIZED: Tween info reuse
local hoverTweenInfo = TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

closeBtn.MouseEnter:Connect(function()
	TweenService:Create(closeBtn, hoverTweenInfo, {TextColor3 = Color3.fromRGB(255, 90, 90)}):Play()
end)
closeBtn.MouseLeave:Connect(function()
	TweenService:Create(closeBtn, hoverTweenInfo, {TextColor3 = Color3.fromRGB(255, 255, 255)}):Play()
end)

-- Tab bar
local tabBar = Instance.new("Frame", window)
tabBar.Position = UDim2.new(0, 0, 0, 46)
tabBar.Size = UDim2.new(1, 0, 0, 44)
tabBar.BackgroundColor3 = Color3.fromRGB(16, 16, 16)
tabBar.BorderSizePixel = 0

local tabLayout = Instance.new("UIListLayout", tabBar)
tabLayout.FillDirection = Enum.FillDirection.Horizontal
tabLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
tabLayout.VerticalAlignment = Enum.VerticalAlignment.Center
tabLayout.Padding = UDim.new(0, 10)

local function makeTab(iconText)
	local b = Instance.new("TextButton", tabBar)
	b.Size = UDim2.new(0, 46, 0, 32)
	b.BackgroundColor3 = Color3.fromRGB(32, 32, 32)
	b.BorderSizePixel = 0
	b.Text = iconText
	b.Font = Enum.Font.GothamBold
	b.TextSize = 16
	b.TextColor3 = Color3.fromRGB(255, 255, 255)
	b.AutoButtonColor = false
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 10)
	return b
end

local tabMain = makeTab("ðŸ”¥")
local tabBuy = makeTab("ðŸ›’")
local tabTp = makeTab("ðŸšª")

-- Content pages
local content = Instance.new("Frame", window)
content.Position = UDim2.new(0, 0, 0, 90)
content.Size = UDim2.new(1, 0, 1, -90)
content.BackgroundTransparency = 1

local function createPage()
	local page = Instance.new("ScrollingFrame", content)
	page.Size = UDim2.new(1, 0, 1, 0)
	page.BackgroundTransparency = 1
	page.BorderSizePixel = 0
	page.ScrollBarThickness = 6
	page.AutomaticCanvasSize = Enum.AutomaticSize.Y
	page.Visible = false
	
	Instance.new("UIPadding", page).PaddingTop = UDim.new(0, 8)
	local layout = Instance.new("UIListLayout", page)
	layout.Padding = UDim.new(0, 10)
	layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
	
	return page
end

local mainPage = createPage()
mainPage.Visible = true
local buyPage = createPage()
local tpPage = createPage()

-- OPTIMIZED: Toggle builder with signal connection
local function makeToggle(parentFrame, labelText, flagName)
	local row = Instance.new("Frame", parentFrame)
	row.Size = UDim2.new(1, -20, 0, 44)
	row.BackgroundTransparency = 1

	local label = Instance.new("TextLabel", row)
	label.BackgroundTransparency = 1
	label.Size = UDim2.new(1, -100, 1, 0)
	label.Font = Enum.Font.Gotham
	label.Text = labelText
	label.TextSize = 14
	label.TextColor3 = Color3.fromRGB(220, 220, 220)
	label.TextXAlignment = Enum.TextXAlignment.Left

	local btn = Instance.new("TextButton", row)
	btn.Size = UDim2.new(0, 86, 0, 30)
	btn.Position = UDim2.new(1, -86, 0.5, -15)
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 14
	btn.AutoButtonColor = false
	btn.BorderSizePixel = 0
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)

	local function refresh()
		local on = _G[flagName] == true
		btn.Text = on and "ON" or "OFF"
		btn.BackgroundColor3 = on and Color3.fromRGB(60, 180, 90) or Color3.fromRGB(170, 50, 50)
	end

	btn.MouseButton1Click:Connect(function()
		_G[flagName] = not _G[flagName]
		refresh()
		changeSignals[flagName]:Fire() -- Notify change
	end)

	-- OPTIMIZED: Only refresh when value changes
	if changeSignals[flagName] then
		changeSignals[flagName]:Connect(refresh)
	end

	refresh()
end

local function makeActionButton(parentFrame, labelText, buttonText, onClick)
	local row = Instance.new("Frame", parentFrame)
	row.BackgroundTransparency = 1
	row.Size = UDim2.new(1, -20, 0, 44)

	local label = Instance.new("TextLabel", row)
	label.BackgroundTransparency = 1
	label.Size = UDim2.new(1, -100, 1, 0)
	label.Font = Enum.Font.Gotham
	label.Text = labelText
	label.TextSize = 14
	label.TextColor3 = Color3.fromRGB(220, 220, 220)
	label.TextXAlignment = Enum.TextXAlignment.Left

	local btn = Instance.new("TextButton", row)
	btn.Size = UDim2.new(0, 86, 0, 30)
	btn.Position = UDim2.new(1, -86, 0.5, -15)
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 14
	btn.AutoButtonColor = false
	btn.BorderSizePixel = 0
	btn.Text = buttonText
	btn.BackgroundColor3 = Color3.fromRGB(55, 120, 200)
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)

	btn.MouseButton1Click:Connect(onClick)

	local pressTweenInfo = TweenInfo.new(0.08, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
	btn.MouseButton1Down:Connect(function()
		TweenService:Create(btn, pressTweenInfo, {
			Size = UDim2.new(0, 82, 0, 28),
			Position = UDim2.new(1, -84, 0.5, -14)
		}):Play()
	end)
	btn.MouseButton1Up:Connect(function()
		TweenService:Create(btn, pressTweenInfo, {
			Size = UDim2.new(0, 86, 0, 30),
			Position = UDim2.new(1, -86, 0.5, -15)
		}):Play()
	end)
end

-- Create toggles
makeToggle(mainPage, "Start / Surrender Loop", "start")
makeToggle(mainPage, "Spam-Wave Start", "spamwave")
makeToggle(buyPage, "Auto Buy: MrsClaus", "autobuyMrsclaus")
makeToggle(buyPage, "Auto Buy: Clasher", "autobuyClasher")
makeToggle(buyPage, "Auto Buy: Grinch", "autobuyGrinch")
makeActionButton(tpPage, "Teleport to Santa", "GO", teleportToSanta)
makeActionButton(tpPage, "Teleport To My Island", "GO", teleportToMyIsland)

-- Tab switching
local tabTweenInfo = TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local function styleTab(btn, active)
	TweenService:Create(btn, tabTweenInfo, {
		BackgroundColor3 = active and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(32, 32, 32)
	}):Play()
end

local function setTab(which)
	mainPage.Visible = (which == "main")
	buyPage.Visible = (which == "buy")
	tpPage.Visible = (which == "tp")
	styleTab(tabMain, which == "main")
	styleTab(tabBuy, which == "buy")
	styleTab(tabTp, which == "tp")
end

tabMain.MouseButton1Click:Connect(function() setTab("main") end)
tabBuy.MouseButton1Click:Connect(function() setTab("buy") end)
tabTp.MouseButton1Click:Connect(function() setTab("tp") end)
setTab("main")

-- Open/Close animations
local openPos = window.Position
local closedPos = UDim2.new(openPos.X.Scale, openPos.X.Offset, openPos.Y.Scale, openPos.Y.Offset + 60)
window.Position = closedPos

local menuHoverTweenInfo = TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local function tweenMenuSlot(hovering, pressed)
	local size = pressed and UDim2.new(0, 60, 0, 60) or (hovering and UDim2.new(0, 68, 0, 68) or UDim2.new(0, 64, 0, 64))
	TweenService:Create(menuSlot, menuHoverTweenInfo, {Size = size}):Play()
	TweenService:Create(glow, menuHoverTweenInfo, {ImageTransparency = hovering and 0.35 or 0.55}):Play()
	TweenService:Create(slotStroke, menuHoverTweenInfo, {
		Color = hovering and Color3.fromRGB(120, 200, 255) or Color3.fromRGB(70, 70, 70)
	}):Play()
end

menuBtn.MouseEnter:Connect(function() tweenMenuSlot(true, false) end)
menuBtn.MouseLeave:Connect(function() tweenMenuSlot(false, false) end)
menuBtn.MouseButton1Down:Connect(function() tweenMenuSlot(true, true) end)
menuBtn.MouseButton1Up:Connect(function() tweenMenuSlot(true, false) end)

local openTweenInfo = TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local closeTweenInfo = TweenInfo.new(0.16, Enum.EasingStyle.Quad, Enum.EasingDirection.In)

local function openWindow()
	window.Visible = true
	window.Position = closedPos
	window.BackgroundTransparency = 1
	winStroke.Transparency = 1
	
	TweenService:Create(window, openTweenInfo, {Position = openPos, BackgroundTransparency = 0}):Play()
	TweenService:Create(winStroke, openTweenInfo, {Transparency = 0.2}):Play()
end

local function closeWindow()
	local posTween = TweenService:Create(window, closeTweenInfo, {Position = closedPos, BackgroundTransparency = 1})
	local strokeTween = TweenService:Create(winStroke, closeTweenInfo, {Transparency = 1})
	
	posTween:Play()
	strokeTween:Play()
	posTween.Completed:Connect(function() window.Visible = false end)
end

local function toggleWindow()
	if window.Visible then closeWindow() else openWindow() end
end

menuBtn.MouseButton1Click:Connect(toggleWindow)
closeBtn.MouseButton1Click:Connect(closeWindow)
