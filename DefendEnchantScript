local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local RS = game:GetService("ReplicatedStorage")
local Events = RS:WaitForChild("Events")
local Functions = Events:WaitForChild("Functions")
local Enchant = Functions:WaitForChild("RollForEnchant")

-- Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "EnchantMenuGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

-- Menu Button (Bottom Right, but left of the other button)
local MenuButton = Instance.new("TextButton")
MenuButton.Name = "EnchantMenuButton"
MenuButton.Size = UDim2.new(0, 60, 0, 60)
MenuButton.Position = UDim2.new(1, -140, 1, -70) -- 70 pixels left of the corner button
MenuButton.AnchorPoint = Vector2.new(0, 0)
MenuButton.BackgroundColor3 = Color3.fromRGB(60, 40, 140)
MenuButton.BorderSizePixel = 0
MenuButton.Text = "✨"
MenuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MenuButton.TextSize = 30
MenuButton.Font = Enum.Font.GothamBold
MenuButton.Parent = ScreenGui

local ButtonCorner = Instance.new("UICorner")
ButtonCorner.CornerRadius = UDim.new(0, 10)
ButtonCorner.Parent = MenuButton

-- Main Menu Frame
local MenuFrame = Instance.new("Frame")
MenuFrame.Name = "MenuFrame"
MenuFrame.Size = UDim2.new(0, 500, 0, 450)
MenuFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MenuFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MenuFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MenuFrame.BorderSizePixel = 0
MenuFrame.Visible = false
MenuFrame.Parent = ScreenGui

local FrameCorner = Instance.new("UICorner")
FrameCorner.CornerRadius = UDim.new(0, 12)
FrameCorner.Parent = MenuFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 50)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MenuFrame

local TitleBarCorner = Instance.new("UICorner")
TitleBarCorner.CornerRadius = UDim.new(0, 12)
TitleBarCorner.Parent = TitleBar

-- Fix corner clipping
local TitleBarFix = Instance.new("Frame")
TitleBarFix.Size = UDim2.new(1, 0, 0, 12)
TitleBarFix.Position = UDim2.new(0, 0, 1, -12)
TitleBarFix.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TitleBarFix.BorderSizePixel = 0
TitleBarFix.Parent = TitleBar

-- Title
local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(1, -20, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "Auto Enchant"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 20
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TitleBar

-- Close Button
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 40, 0, 40)
CloseButton.Position = UDim2.new(1, -45, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.BorderSizePixel = 0
CloseButton.Text = "✕"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 20
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseButton

-- Status Label
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Size = UDim2.new(1, -20, 0, 30)
StatusLabel.Position = UDim2.new(0, 10, 0, 55)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: Ready"
StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
StatusLabel.TextSize = 16
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = MenuFrame

-- Tab Container
local TabContainer = Instance.new("Frame")
TabContainer.Name = "TabContainer"
TabContainer.Size = UDim2.new(1, -20, 0, 40)
TabContainer.Position = UDim2.new(0, 10, 0, 90)
TabContainer.BackgroundTransparency = 1
TabContainer.Parent = MenuFrame

-- Tab 1: Defense Selection
local Tab1Button = Instance.new("TextButton")
Tab1Button.Name = "Tab1Button"
Tab1Button.Size = UDim2.new(0.5, -5, 1, 0)
Tab1Button.Position = UDim2.new(0, 0, 0, 0)
Tab1Button.BackgroundColor3 = Color3.fromRGB(60, 40, 140)
Tab1Button.BorderSizePixel = 0
Tab1Button.Text = "Select Defense"
Tab1Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Tab1Button.TextSize = 16
Tab1Button.Font = Enum.Font.GothamBold
Tab1Button.Parent = TabContainer

local Tab1Corner = Instance.new("UICorner")
Tab1Corner.CornerRadius = UDim.new(0, 8)
Tab1Corner.Parent = Tab1Button

-- Tab 2: Enchant Count Selection
local Tab2Button = Instance.new("TextButton")
Tab2Button.Name = "Tab2Button"
Tab2Button.Size = UDim2.new(0.5, -5, 1, 0)
Tab2Button.Position = UDim2.new(0.5, 5, 0, 0)
Tab2Button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
Tab2Button.BorderSizePixel = 0
Tab2Button.Text = "Enchant Count"
Tab2Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Tab2Button.TextSize = 16
Tab2Button.Font = Enum.Font.GothamBold
Tab2Button.Parent = TabContainer

local Tab2Corner = Instance.new("UICorner")
Tab2Corner.CornerRadius = UDim.new(0, 8)
Tab2Corner.Parent = Tab2Button

-- Content Frame for Tab 1 (Defense List)
local Tab1Content = Instance.new("ScrollingFrame")
Tab1Content.Name = "Tab1Content"
Tab1Content.Size = UDim2.new(1, -20, 1, -220)
Tab1Content.Position = UDim2.new(0, 10, 0, 140)
Tab1Content.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
Tab1Content.BorderSizePixel = 0
Tab1Content.ScrollBarThickness = 6
Tab1Content.Visible = true
Tab1Content.Parent = MenuFrame

local Tab1Corner = Instance.new("UICorner")
Tab1Corner.CornerRadius = UDim.new(0, 8)
Tab1Corner.Parent = Tab1Content

local Tab1Layout = Instance.new("UIListLayout")
Tab1Layout.Padding = UDim.new(0, 5)
Tab1Layout.SortOrder = Enum.SortOrder.Name
Tab1Layout.Parent = Tab1Content

-- Content Frame for Tab 2 (Enchant Count)
local Tab2Content = Instance.new("Frame")
Tab2Content.Name = "Tab2Content"
Tab2Content.Size = UDim2.new(1, -20, 1, -220)
Tab2Content.Position = UDim2.new(0, 10, 0, 140)
Tab2Content.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
Tab2Content.BorderSizePixel = 0
Tab2Content.Visible = false
Tab2Content.Parent = MenuFrame

local Tab2ContentCorner = Instance.new("UICorner")
Tab2ContentCorner.CornerRadius = UDim.new(0, 8)
Tab2ContentCorner.Parent = Tab2Content

local Tab2Layout = Instance.new("UIGridLayout")
Tab2Layout.CellSize = UDim2.new(0, 230, 0, 100)
Tab2Layout.CellPadding = UDim2.new(0, 10, 0, 10)
Tab2Layout.SortOrder = Enum.SortOrder.LayoutOrder
Tab2Layout.Parent = Tab2Content

-- Padding for Tab 2
local Tab2Padding = Instance.new("UIPadding")
Tab2Padding.PaddingTop = UDim.new(0, 10)
Tab2Padding.PaddingLeft = UDim.new(0, 10)
Tab2Padding.Parent = Tab2Content

-- Start Enchant Button
local StartButton = Instance.new("TextButton")
StartButton.Name = "StartButton"
StartButton.Size = UDim2.new(1, -20, 0, 50)
StartButton.Position = UDim2.new(0, 10, 1, -60)
StartButton.BackgroundColor3 = Color3.fromRGB(0, 180, 80)
StartButton.BorderSizePixel = 0
StartButton.Text = "Start Enchanting"
StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StartButton.TextSize = 18
StartButton.Font = Enum.Font.GothamBold
StartButton.Parent = MenuFrame

local StartButtonCorner = Instance.new("UICorner")
StartButtonCorner.CornerRadius = UDim.new(0, 8)
StartButtonCorner.Parent = StartButton

-- Variables
local selectedDefense = nil
local selectedCount = 500
local isEnchanting = false
local enchantCounts = {100, 250, 500, 1000}

-- Create enchant count buttons
for i, count in ipairs(enchantCounts) do
    local CountButton = Instance.new("TextButton")
    CountButton.Name = "Count"..count
    CountButton.Size = UDim2.new(0, 230, 0, 100)
    CountButton.BackgroundColor3 = (count == 500) and Color3.fromRGB(60, 120, 200) or Color3.fromRGB(50, 50, 50)
    CountButton.BorderSizePixel = 0
    CountButton.Text = count.." Rolls"
    CountButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CountButton.TextSize = 24
    CountButton.Font = Enum.Font.GothamBold
    CountButton.LayoutOrder = i
    CountButton.Parent = Tab2Content
    
    local CountCorner = Instance.new("UICorner")
    CountCorner.CornerRadius = UDim.new(0, 8)
    CountCorner.Parent = CountButton
    
    CountButton.MouseButton1Click:Connect(function()
        selectedCount = count
        -- Update all buttons
        for _, child in ipairs(Tab2Content:GetChildren()) do
            if child:IsA("TextButton") then
                child.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            end
        end
        CountButton.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
    end)
end

-- Function to load defenses from inventory
local function loadDefenses()
    -- Clear existing
    for _, child in ipairs(Tab1Content:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    local Inventory = Player:WaitForChild("Inventory")
    local Defenses = Inventory:WaitForChild("Defenses")
    
    for _, defense in ipairs(Defenses:GetChildren()) do
        local defenseId = defense.Name
        local defenseName = defenseId:match("^(.-)%{") or defenseId
        
        -- Get defense level
        local level = "?"
        local levelObj = defense:FindFirstChild("Level")
        if levelObj then
            level = tostring(levelObj.Value)
        end
        
        local DefenseButton = Instance.new("TextButton")
        DefenseButton.Name = defenseId
        DefenseButton.Size = UDim2.new(1, -10, 0, 50)
        DefenseButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        DefenseButton.BorderSizePixel = 0
        DefenseButton.Text = `{defenseName} [Lv.{level}]`
        DefenseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        DefenseButton.TextSize = 16
        DefenseButton.Font = Enum.Font.Gotham
        DefenseButton.TextXAlignment = Enum.TextXAlignment.Left
        DefenseButton.Parent = Tab1Content
        
        local DefenseCorner = Instance.new("UICorner")
        DefenseCorner.CornerRadius = UDim.new(0, 8)
        DefenseCorner.Parent = DefenseButton
        
        local Padding = Instance.new("UIPadding")
        Padding.PaddingLeft = UDim.new(0, 10)
        Padding.Parent = DefenseButton
        
        DefenseButton.MouseButton1Click:Connect(function()
            selectedDefense = defenseId
            -- Update all buttons
            for _, child in ipairs(Tab1Content:GetChildren()) do
                if child:IsA("TextButton") then
                    child.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                end
            end
            DefenseButton.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
        end)
    end
    
    -- Update canvas size
    Tab1Content.CanvasSize = UDim2.new(0, 0, 0, Tab1Layout.AbsoluteContentSize.Y + 10)
end

-- Tab switching
Tab1Button.MouseButton1Click:Connect(function()
    Tab1Content.Visible = true
    Tab2Content.Visible = false
    Tab1Button.BackgroundColor3 = Color3.fromRGB(60, 40, 140)
    Tab2Button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
end)

Tab2Button.MouseButton1Click:Connect(function()
    Tab1Content.Visible = false
    Tab2Content.Visible = true
    Tab1Button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    Tab2Button.BackgroundColor3 = Color3.fromRGB(60, 40, 140)
end)

-- Menu toggle
MenuButton.MouseButton1Click:Connect(function()
    MenuFrame.Visible = not MenuFrame.Visible
    if MenuFrame.Visible then
        loadDefenses()
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    MenuFrame.Visible = false
end)

-- Enchanting function
local function startEnchanting()
    if isEnchanting then
        warn("Already enchanting!")
        return
    end
    
    if not selectedDefense then
        StatusLabel.Text = "Status: No defense selected!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        task.wait(2)
        StatusLabel.Text = "Status: Ready"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        return
    end
    
    isEnchanting = true
    StartButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    StartButton.Text = "Enchanting..."
    
    task.spawn(function()
        StatusLabel.Text = `Status: Enchanting {selectedCount} times...`
        StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
        
        for i = 1, selectedCount do
            local success, result = pcall(function()
                return Enchant:InvokeServer(selectedDefense)
            end)
            
            if not success then
                warn(`Failed on roll {i}: {result}`)
            end
            
            if i % 50 == 0 then
                StatusLabel.Text = `Status: Enchanting... ({i}/{selectedCount})`
            end
            
            task.wait()
        end
        
        StatusLabel.Text = "Status: Completed!"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        print("Successfully Enchanted All")
        
        isEnchanting = false
        StartButton.BackgroundColor3 = Color3.fromRGB(0, 180, 80)
        StartButton.Text = "Start Enchanting"
        
        task.wait(3)
        StatusLabel.Text = "Status: Ready"
    end)
end

StartButton.MouseButton1Click:Connect(startEnchanting)

-- Update canvas size when layout changes
Tab1Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    Tab1Content.CanvasSize = UDim2.new(0, 0, 0, Tab1Layout.AbsoluteContentSize.Y + 10)
end)

print("Auto Enchant Menu loaded!")
