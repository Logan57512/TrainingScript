local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local RS = game:GetService("ReplicatedStorage")
local Events = RS:WaitForChild("Events")
local Functions = Events:WaitForChild("Functions")
local Enchant = Functions:WaitForChild("RollForEnchant")

-- Create ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "EnchantMenuGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

-- Menu Button (Bottom Right, but left of the other button)
local MenuButton = Instance.new("TextButton")
MenuButton.Name = "EnchantMenuButton"
MenuButton.Size = UDim2.new(0, 60, 0, 60)
MenuButton.Position = UDim2.new(1, -140, 1, -70)
MenuButton.AnchorPoint = Vector2.new(0, 0)
MenuButton.BackgroundColor3 = Color3.fromRGB(60, 40, 140)
MenuButton.BorderSizePixel = 0
MenuButton.Text = "✨"
MenuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MenuButton.TextSize = 30
MenuButton.Font = Enum.Font.GothamBold
MenuButton.Parent = ScreenGui

local ButtonCorner = Instance.new("UICorner")
ButtonCorner.CornerRadius = UDim.new(0, 10)
ButtonCorner.Parent = MenuButton

-- Main Menu Frame
local MenuFrame = Instance.new("Frame")
MenuFrame.Name = "MenuFrame"
MenuFrame.Size = UDim2.new(0, 400, 0, 450)
MenuFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MenuFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MenuFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MenuFrame.BorderSizePixel = 0
MenuFrame.Visible = false
MenuFrame.Parent = ScreenGui

local FrameCorner = Instance.new("UICorner")
FrameCorner.CornerRadius = UDim.new(0, 12)
FrameCorner.Parent = MenuFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 50)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MenuFrame

local TitleBarCorner = Instance.new("UICorner")
TitleBarCorner.CornerRadius = UDim.new(0, 12)
TitleBarCorner.Parent = TitleBar

-- Fix corner clipping
local TitleBarFix = Instance.new("Frame")
TitleBarFix.Size = UDim2.new(1, 0, 0, 12)
TitleBarFix.Position = UDim2.new(0, 0, 1, -12)
TitleBarFix.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TitleBarFix.BorderSizePixel = 0
TitleBarFix.Parent = TitleBar

-- Title
local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(1, -20, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "Auto Enchant"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 20
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TitleBar

-- Close Button
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 40, 0, 40)
CloseButton.Position = UDim2.new(1, -45, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.BorderSizePixel = 0
CloseButton.Text = "✕"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 20
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseButton

-- Status Label
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Size = UDim2.new(1, -20, 0, 30)
StatusLabel.Position = UDim2.new(0, 10, 0, 55)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: Ready"
StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
StatusLabel.TextSize = 16
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = MenuFrame

-- Defense List Label
local DefenseLabel = Instance.new("TextLabel")
DefenseLabel.Name = "DefenseLabel"
DefenseLabel.Size = UDim2.new(1, -20, 0, 30)
DefenseLabel.Position = UDim2.new(0, 10, 0, 90)
DefenseLabel.BackgroundTransparency = 1
DefenseLabel.Text = "Select a Defense:"
DefenseLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
DefenseLabel.TextSize = 14
DefenseLabel.Font = Enum.Font.GothamBold
DefenseLabel.TextXAlignment = Enum.TextXAlignment.Left
DefenseLabel.Parent = MenuFrame

-- Defense List ScrollingFrame
local DefenseList = Instance.new("ScrollingFrame")
DefenseList.Name = "DefenseList"
DefenseList.Size = UDim2.new(1, -20, 1, -140)
DefenseList.Position = UDim2.new(0, 10, 0, 125)
DefenseList.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
DefenseList.BorderSizePixel = 0
DefenseList.ScrollBarThickness = 6
DefenseList.Parent = MenuFrame

local ListCorner = Instance.new("UICorner")
ListCorner.CornerRadius = UDim.new(0, 8)
ListCorner.Parent = DefenseList

local ListLayout = Instance.new("UIListLayout")
ListLayout.Padding = UDim.new(0, 5)
ListLayout.SortOrder = Enum.SortOrder.Name
ListLayout.Parent = DefenseList

-- Popup Frame for Count Selection
local PopupFrame = Instance.new("Frame")
PopupFrame.Name = "PopupFrame"
PopupFrame.Size = UDim2.new(0, 350, 0, 300)
PopupFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
PopupFrame.AnchorPoint = Vector2.new(0.5, 0.5)
PopupFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
PopupFrame.BorderSizePixel = 0
PopupFrame.Visible = false
PopupFrame.ZIndex = 10
PopupFrame.Parent = ScreenGui

local PopupCorner = Instance.new("UICorner")
PopupCorner.CornerRadius = UDim.new(0, 12)
PopupCorner.Parent = PopupFrame

-- Popup Title
local PopupTitle = Instance.new("TextLabel")
PopupTitle.Name = "PopupTitle"
PopupTitle.Size = UDim2.new(1, -20, 0, 40)
PopupTitle.Position = UDim2.new(0, 10, 0, 10)
PopupTitle.BackgroundTransparency = 1
PopupTitle.Text = "Select Enchant Count"
PopupTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
PopupTitle.TextSize = 18
PopupTitle.Font = Enum.Font.GothamBold
PopupTitle.TextXAlignment = Enum.TextXAlignment.Center
PopupTitle.ZIndex = 10
PopupTitle.Parent = PopupFrame

-- Popup Grid Container
local PopupGrid = Instance.new("Frame")
PopupGrid.Name = "PopupGrid"
PopupGrid.Size = UDim2.new(1, -20, 1, -110)
PopupGrid.Position = UDim2.new(0, 10, 0, 55)
PopupGrid.BackgroundTransparency = 1
PopupGrid.ZIndex = 10
PopupGrid.Parent = PopupFrame

local GridLayout = Instance.new("UIGridLayout")
GridLayout.CellSize = UDim2.new(0, 100, 0, 80)
GridLayout.CellPadding = UDim2.new(0, 5, 0, 5)
GridLayout.SortOrder = Enum.SortOrder.LayoutOrder
GridLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
GridLayout.Parent = PopupGrid

-- Popup Cancel Button
local PopupCancel = Instance.new("TextButton")
PopupCancel.Name = "PopupCancel"
PopupCancel.Size = UDim2.new(1, -20, 0, 40)
PopupCancel.Position = UDim2.new(0, 10, 1, -50)
PopupCancel.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
PopupCancel.BorderSizePixel = 0
PopupCancel.Text = "Cancel"
PopupCancel.TextColor3 = Color3.fromRGB(255, 255, 255)
PopupCancel.TextSize = 16
PopupCancel.Font = Enum.Font.GothamBold
PopupCancel.ZIndex = 10
PopupCancel.Parent = PopupFrame

local CancelCorner = Instance.new("UICorner")
CancelCorner.CornerRadius = UDim.new(0, 8)
CancelCorner.Parent = PopupCancel

-- Variables
local selectedDefense = nil
local selectedDefenseName = ""
local isEnchanting = false
local enchantCounts = {100, 250, 500, 1000, 5000}

-- Create count buttons in popup
for i, count in ipairs(enchantCounts) do
    local CountButton = Instance.new("TextButton")
    CountButton.Name = "Count"..count
    CountButton.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
    CountButton.BorderSizePixel = 0
    CountButton.Text = count
    CountButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CountButton.TextSize = 20
    CountButton.Font = Enum.Font.GothamBold
    CountButton.LayoutOrder = i
    CountButton.ZIndex = 10
    CountButton.Parent = PopupGrid
    
    local CountCorner = Instance.new("UICorner")
    CountCorner.CornerRadius = UDim.new(0, 8)
    CountCorner.Parent = CountButton
    
    CountButton.MouseButton1Click:Connect(function()
        if not selectedDefense then return end
        PopupFrame.Visible = false
        startEnchanting(count)
    end)
end

-- Function to show popup
local function showPopup()
    if not selectedDefense then
        StatusLabel.Text = "Status: No defense selected!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        task.wait(2)
        StatusLabel.Text = "Status: Ready"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        return
    end
    PopupFrame.Visible = true
end

-- Close popup
PopupCancel.MouseButton1Click:Connect(function()
    PopupFrame.Visible = false
end)

-- Function to load defenses from inventory
local function loadDefenses()
    -- Clear existing
    for _, child in ipairs(DefenseList:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    local Inventory = Player:WaitForChild("Inventory")
    local Defenses = Inventory:WaitForChild("Defenses")
    
    for _, defense in ipairs(Defenses:GetChildren()) do
        local defenseId = defense.Name
        local defenseName = defenseId:match("^(.-)%{") or defenseId
        
        -- Get defense level
        local level = "?"
        local levelObj = defense:FindFirstChild("Level")
        if levelObj then
            level = tostring(levelObj.Value)
        end
        
        local DefenseButton = Instance.new("TextButton")
        DefenseButton.Name = defenseId
        DefenseButton.Size = UDim2.new(1, -10, 0, 50)
        DefenseButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        DefenseButton.BorderSizePixel = 0
        DefenseButton.Text = `{defenseName} [Lv.{level}]`
        DefenseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        DefenseButton.TextSize = 16
        DefenseButton.Font = Enum.Font.Gotham
        DefenseButton.TextXAlignment = Enum.TextXAlignment.Left
        DefenseButton.Parent = DefenseList
        
        local DefenseCorner = Instance.new("UICorner")
        DefenseCorner.CornerRadius = UDim.new(0, 8)
        DefenseCorner.Parent = DefenseButton
        
        local Padding = Instance.new("UIPadding")
        Padding.PaddingLeft = UDim.new(0, 10)
        Padding.Parent = DefenseButton
        
        -- Enchant button on the right
        local EnchantBtn = Instance.new("TextButton")
        EnchantBtn.Name = "EnchantBtn"
        EnchantBtn.Size = UDim2.new(0, 80, 0, 35)
        EnchantBtn.Position = UDim2.new(1, -90, 0.5, 0)
        EnchantBtn.AnchorPoint = Vector2.new(0, 0.5)
        EnchantBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 80)
        EnchantBtn.BorderSizePixel = 0
        EnchantBtn.Text = "Enchant"
        EnchantBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        EnchantBtn.TextSize = 14
        EnchantBtn.Font = Enum.Font.GothamBold
        EnchantBtn.Parent = DefenseButton
        
        local EnchantCorner = Instance.new("UICorner")
        EnchantCorner.CornerRadius = UDim.new(0, 6)
        EnchantCorner.Parent = EnchantBtn
        
        EnchantBtn.MouseButton1Click:Connect(function()
            selectedDefense = defenseId
            selectedDefenseName = defenseName
            showPopup()
        end)
    end
    
    -- Update canvas size
    DefenseList.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 10)
end

-- Menu toggle
MenuButton.MouseButton1Click:Connect(function()
    MenuFrame.Visible = not MenuFrame.Visible
    if MenuFrame.Visible then
        loadDefenses()
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    MenuFrame.Visible = false
end)

-- Enchanting function
function startEnchanting(count)
    if isEnchanting then
        warn("Already enchanting!")
        return
    end
    
    isEnchanting = true
    
    task.spawn(function()
        StatusLabel.Text = `Status: Enchanting {selectedDefenseName} {count} times...`
        StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
        
        for i = 1, count do
            local success, result = pcall(function()
                return Enchant:InvokeServer(selectedDefense)
            end)
            
            if not success then
                warn(`Failed on roll {i}: {result}`)
            end
            
            if i % 50 == 0 then
                StatusLabel.Text = `Status: Enchanting... ({i}/{count})`
            end
            
            task.wait()
        end
        
        StatusLabel.Text = "Status: Completed!"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        print("Successfully Enchanted All")
        
        isEnchanting = false
        
        task.wait(3)
        StatusLabel.Text = "Status: Ready"
    end)
end

-- Update canvas size when layout changes
ListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    DefenseList.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 10)
end)
